<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶“å…¸è²ªåƒè›‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•æ²å‹•é é¢ */
            background-color: #111827;
        }

        .retro-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* éŠæˆ²ç•«å¸ƒé‚Šæ¡†ç™¼å…‰æ•ˆæœ */
        #gameCanvas {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        /* è™›æ“¬æŒ‰éˆ•æ¨£å¼ */
        .d-pad-btn {
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
        }
        .d-pad-btn:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center bg-gray-900 text-white overflow-hidden">

    <!-- éŠæˆ²æ¨™é¡Œèˆ‡åˆ†æ•¸ -->
    <div class="w-full max-w-md flex justify-between items-center px-4 mb-4">
        <h1 class="text-xl font-bold text-green-400 flex items-center gap-2">
            <span>ğŸ</span> è²ªåƒè›‡
        </h1>
        <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
            <span class="text-gray-400 text-sm">åˆ†æ•¸</span>
            <span id="scoreEl" class="ml-2 text-xl font-bold text-white retro-font">0</span>
        </div>
    </div>

    <!-- éŠæˆ²å€åŸŸå®¹å™¨ (ç›¸å°å®šä½ç”¨æ–¼æ”¾ç½®è¦†è“‹å±¤) -->
    <div class="relative group">
        <canvas id="gameCanvas" width="400" height="400" class="bg-black rounded-lg border-2 border-gray-700 block"></canvas>
        
        <!-- é–‹å§‹/çµæŸ è¦†è“‹å±¤ -->
        <div id="uiOverlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center rounded-lg z-10">
            <h2 id="gameTitle" class="text-4xl font-bold text-green-500 mb-2 retro-font tracking-widest">SNAKE</h2>
            <p id="finalScore" class="text-gray-300 mb-6 hidden">æœ€çµ‚åˆ†æ•¸: <span class="text-white font-bold">0</span></p>
            <button id="startBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                é–‹å§‹éŠæˆ²
            </button>
            <p class="mt-4 text-xs text-gray-500">é›»è…¦æŒ‰æ–¹å‘éµ â€¢ æ‰‹æ©ŸæŒ‰ä¸‹æ–¹æŒ‰éˆ•</p>
        </div>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆæ§åˆ¶å™¨ (D-Pad) -->
    <div class="mt-6 grid grid-cols-3 gap-2 w-full max-w-[280px] md:hidden">
        <div></div>
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowUp')">â¬†ï¸</button>
        <div></div>
        
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowLeft')">â¬…ï¸</button>
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowDown')">â¬‡ï¸</button>
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowRight')">â¡ï¸</button>
    </div>

    <!-- æ¡Œé¢ç«¯æç¤º -->
    <div class="hidden md:block mt-4 text-gray-500 text-sm">
        ä½¿ç”¨éµç›¤æ–¹å‘éµæ§åˆ¶ç§»å‹•
    </div>

    <script>
        // --- éŠæˆ²è¨­å®š ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('scoreEl');
        const uiOverlay = document.getElementById('uiOverlay');
        const startBtn = document.getElementById('startBtn');
        const finalScoreEl = document.getElementById('finalScore');
        const gameTitle = document.getElementById('gameTitle');

        // ç¶²æ ¼è¨­å®š
        const tileCount = 20; // 20x20 çš„ç¶²æ ¼
        let tileSize = canvas.width / tileCount - 2; // æ ¼å­å¤§å° (æ¸›2æ˜¯ç‚ºäº†ç•™ä¸€é»ç¸«éš™)
        
        // éŸ¿æ‡‰å¼ç•«å¸ƒå¤§å°èª¿æ•´
        function resizeCanvas() {
            // åœ¨å°è¢å¹•ä¸Šï¼Œç•«å¸ƒå¯¬åº¦è¨­ç‚ºè¢å¹•å¯¬åº¦çš„ 90% (æœ€å¤§ 400px)
            const maxWidth = Math.min(window.innerWidth - 32, 400);
            canvas.width = maxWidth;
            canvas.height = maxWidth;
            tileSize = canvas.width / tileCount;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // åˆå§‹åŒ–æ™‚åŸ·è¡Œä¸€æ¬¡

        // éŠæˆ²è®Šæ•¸
        let speed = 7; // æ¯ç§’æ›´æ–°æ¬¡æ•¸ (FPS)
        let score = 0;
        let headX = 10;
        let headY = 10;
        let velocityX = 0;
        let velocityY = 0;
        
        // è›‡èº«é™£åˆ— (æ¯å€‹éƒ¨åˆ†æ˜¯ä¸€å€‹ {x, y} ç‰©ä»¶)
        class SnakePart {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }
        let snakeParts = [];
        let tailLength = 2;

        // é£Ÿç‰©ä½ç½®
        let appleX = 5;
        let appleY = 5;

        // éŠæˆ²è¿´åœˆæ§åˆ¶
        let gameInterval;
        let isRunning = false;
        
        // [ä¿®æ”¹ 1] è¼¸å…¥ç·©è¡å€ï¼Œè§£æ±ºå¿«é€Ÿè¿´è½‰è‡ªæ®ºå•é¡Œ
        let inputQueue = []; 

        // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

        function startGame() {
            if (isRunning) return;
            
            // é‡ç½®è®Šæ•¸
            headX = 10;
            headY = 10;
            velocityX = 0;
            velocityY = 0;
            snakeParts = [];
            tailLength = 2;
            score = 0;
            speed = 7;
            inputQueue = []; // æ¸…ç©ºè¼¸å…¥ç·©è¡
            
            scoreEl.innerText = score;
            uiOverlay.classList.add('hidden');
            
            // éš¨æ©Ÿæ”¾ç½®è˜‹æœ
            placeApple();

            isRunning = true;
            drawGame();
        }

        function gameOver() {
            isRunning = false;
            clearTimeout(gameInterval);
            
            gameTitle.innerText = "GAME OVER";
            gameTitle.className = "text-4xl font-bold text-red-500 mb-2 retro-font tracking-widest";
            
            finalScoreEl.querySelector('span').innerText = score;
            finalScoreEl.classList.remove('hidden');
            
            startBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                å†ç©ä¸€æ¬¡
            `;
            uiOverlay.classList.remove('hidden');
        }

        function drawGame() {
            if (!isRunning) return;

            // [ä¿®æ”¹ 1] æ¯ä¸€å¹€è™•ç†ä¸€å€‹è¼¸å…¥æŒ‡ä»¤
            processInputQueue();

            changeSnakePosition();
            
            let result = isGameOver();
            if (result) {
                return gameOver();
            }

            clearScreen();
            checkAppleCollision();
            drawApple();
            drawSnake();
            
            // æ ¹æ“šåˆ†æ•¸ç¨å¾®å¢åŠ é€Ÿåº¦ï¼Œæœ€é«˜ä¸è¶…é 15 FPS
            let currentSpeed = 7 + Math.floor(score / 5); 
            if (currentSpeed > 15) currentSpeed = 15;

            gameInterval = setTimeout(drawGame, 1000 / currentSpeed);
        }

        // [ä¿®æ”¹ 1] è™•ç†è¼¸å…¥ç·©è¡çš„è¼”åŠ©å‡½å¼
        function processInputQueue() {
            if (inputQueue.length > 0) {
                const nextDir = inputQueue.shift(); // å–å‡ºæœ€æ—©çš„ä¸€å€‹æŒ‡ä»¤
                
                if (nextDir === 'up') { velocityX = 0; velocityY = -1; }
                else if (nextDir === 'down') { velocityX = 0; velocityY = 1; }
                else if (nextDir === 'left') { velocityX = -1; velocityY = 0; }
                else if (nextDir === 'right') { velocityX = 1; velocityY = 0; }
            }
        }

        function isGameOver() {
            let gameOver = false;

            // é–‹å§‹æ™‚ä¸å‹•ä¸ç®—è¼¸
            if (velocityX === 0 && velocityY === 0) return false;

            // æ’ç‰†
            if (headX < 0 || headX >= tileCount || headY < 0 || headY >= tileCount) {
                gameOver = true;
            }

            // æ’è‡ªå·±
            for (let i = 0; i < snakeParts.length; i++) {
                let part = snakeParts[i];
                if (part.x === headX && part.y === headY) {
                    gameOver = true;
                    break;
                }
            }

            return gameOver;
        }

        function clearScreen() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function drawSnake() {
            // ç•«è›‡èº«
            ctx.fillStyle = '#4ade80'; // green-400
            for (let i = 0; i < snakeParts.length; i++) {
                let part = snakeParts[i];
                // ç¹ªè£½ç¨å¾®æ¯”æ ¼å­å°çš„çŸ©å½¢ï¼Œè£½é€ åˆ†ç¯€æ•ˆæœ
                ctx.fillRect(part.x * tileSize + 1, part.y * tileSize + 1, tileSize - 2, tileSize - 2);
            }

            // æŠŠé ­éƒ¨ä½ç½®åŠ å…¥é™£åˆ—
            snakeParts.push(new SnakePart(headX, headY));
            // å¦‚æœé•·åº¦è¶…éé™åˆ¶ï¼Œç§»é™¤å°¾å·´
            while (snakeParts.length > tailLength) {
                snakeParts.shift();
            }

            // ç•«è›‡é ­ (ç¨å¾®ä¸åŒé¡è‰²æˆ–äº®ä¸€é»)
            ctx.fillStyle = '#86efac'; // green-300
            ctx.fillRect(headX * tileSize + 1, headY * tileSize + 1, tileSize - 2, tileSize - 2);
            
            // ç•«çœ¼ç› (è£é£¾ç”¨)
            ctx.fillStyle = 'black';
            if (velocityX === 1) { // å‘å³
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
            } else if (velocityX === -1) { // å‘å·¦
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
            } else if (velocityY === -1) { // å‘ä¸Š
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
            } else { // å‘ä¸‹æˆ–éœæ­¢
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
            }
        }

        function changeSnakePosition() {
            headX = headX + velocityX;
            headY = headY + velocityY;
        }

        // [ä¿®æ”¹ 2] ç¹ªè£½æ›´åƒè˜‹æœçš„åœ–æ¡ˆ
        function drawApple() {
            let cx = appleX * tileSize + tileSize / 2;
            let cy = appleY * tileSize + tileSize / 2;
            let radius = tileSize / 2 - 2;

            // 1. è˜‹æœæœ¬é«” (ç´…è‰²åœ“å½¢)
            ctx.fillStyle = '#ef4444'; // red-500
            ctx.beginPath();
            // ç¨å¾®å¾€ä¸‹ç§»ä¸€é»é»è®“è‘‰å­æœ‰ç©ºé–“
            ctx.arc(cx, cy + 1, radius, 0, 2 * Math.PI);
            ctx.fill();

            // 2. è’‚é ­ (å’–å•¡è‰²)
            ctx.fillStyle = '#8B4513'; // SaddleBrown
            // åœ¨è˜‹æœé ‚éƒ¨ç•«ä¸€å€‹å°çŸ©å½¢
            ctx.fillRect(cx - 1, cy - radius - 2, 2, 4);

            // 3. è‘‰å­ (ç¶ è‰²)
            ctx.fillStyle = '#4ade80'; // green-400
            ctx.beginPath();
            // ç•«ä¸€å€‹æ©¢åœ“ç•¶è‘‰å­
            ctx.ellipse(cx + 3, cy - radius, 3, 5, Math.PI / 4, 0, 2 * Math.PI);
            ctx.fill();
            
            // å¢åŠ ä¸€é»é«˜å…‰è®“å®ƒçœ‹èµ·ä¾†ç«‹é«” (é¸ç”¨)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(cx - radius/3, cy - radius/3 + 1, radius/4, 0, 2 * Math.PI);
            ctx.fill();
        }

        function checkAppleCollision() {
            if (appleX === headX && appleY === headY) {
                appleX = Math.floor(Math.random() * tileCount);
                appleY = Math.floor(Math.random() * tileCount);
                
                // ç¢ºä¿è˜‹æœä¸æœƒç”Ÿåœ¨è›‡èº«ä¸Š
                for (let part of snakeParts) {
                    if (part.x === appleX && part.y === appleY) {
                        // å¦‚æœé‡ç–Šï¼Œå†è©¦ä¸€æ¬¡
                        checkAppleCollision(); 
                        return;
                    }
                }

                tailLength++;
                score++;
                scoreEl.innerText = score;
                
                // è¦–è¦ºåé¥‹ (éœ‡å‹•æ•ˆæœ - é€™è£¡ç°¡å–®æ¨¡æ“¬)
                canvas.style.transform = "scale(1.02)";
                setTimeout(() => canvas.style.transform = "scale(1)", 50);
            }
        }

        function placeApple() {
            appleX = Math.floor(Math.random() * tileCount);
            appleY = Math.floor(Math.random() * tileCount);
        }

        // --- è¼¸å…¥æ§åˆ¶ ---

        // è¼”åŠ©å‡½å¼ï¼šå–å¾—ç•¶å‰è›‡çš„é‚è¼¯æ–¹å‘ (è€ƒæ…®ç·©è¡å€)
        function getCurrentDirection() {
            // å¦‚æœç·©è¡å€æœ‰æŒ‡ä»¤ï¼Œæˆ‘å€‘æ‡‰è©²ä¾æ“šã€Œæœ€å¾Œä¸€å€‹è¨ˆåŠƒä¸­çš„æŒ‡ä»¤ã€ä¾†åˆ¤æ–·ä¸‹ä¸€å€‹æŒ‡ä»¤æ˜¯å¦åˆæ³•
            if (inputQueue.length > 0) {
                return inputQueue[inputQueue.length - 1];
            }
            // å¦‚æœç·©è¡å€æ˜¯ç©ºçš„ï¼Œä¾æ“šç›®å‰çš„ç‰©ç†é€Ÿåº¦åˆ¤æ–·
            if (velocityX === 1) return 'right';
            if (velocityX === -1) return 'left';
            if (velocityY === 1) return 'down';
            if (velocityY === -1) return 'up';
            return ''; // éœæ­¢
        }

        function handleInput(key) {
            const direction = key.replace('Arrow', '').toLowerCase(); // è½‰æˆ up, down, left, right
            const currentDir = getCurrentDirection();

            // æª¢æŸ¥æ˜¯å¦ç‚ºåå‘ç§»å‹• (å¦‚æœæ˜¯åå‘å‰‡å¿½ç•¥)
            // ä¸¦ä¸”æª¢æŸ¥æ˜¯å¦èˆ‡ç•¶å‰æ–¹å‘ç›¸åŒ (ç›¸åŒå‰‡å¿½ç•¥)
            
            if (direction === 'up' && currentDir !== 'down' && currentDir !== 'up') {
                inputQueue.push('up');
            }
            else if (direction === 'down' && currentDir !== 'up' && currentDir !== 'down') {
                inputQueue.push('down');
            }
            else if (direction === 'left' && currentDir !== 'right' && currentDir !== 'left') {
                inputQueue.push('left');
            }
            else if (direction === 'right' && currentDir !== 'left' && currentDir !== 'right') {
                inputQueue.push('right');
            }

            // é™åˆ¶ç·©è¡å€å¤§å°ï¼Œé¿å…æŒ‰å¤ªå¿«å°è‡´å»¶é²æ„Ÿ (æœ€å¤šå­˜2å€‹æŒ‡ä»¤)
            if (inputQueue.length > 2) {
                // ç§»é™¤å¤šé¤˜çš„æŒ‡ä»¤ï¼Œä¿æŒéšŠåˆ—çŸ­å°
                // é€™è£¡æˆ‘å€‘åªä¿ç•™æœ€æ–°çš„2å€‹ï¼Œä½†å…¶å¯¦æ¨™æº–åšæ³•æ˜¯åªå…è¨± push 2å€‹ã€‚
                // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é€™è£¡ä¸åšé¡å¤–æ“ä½œï¼Œä¸Šé¢çš„é‚è¼¯å·²ç¶“è¶³å¤ é˜²æ­¢éåº¦å †ç©ï¼Œ
                // å› ç‚º drawGame è·‘å¾—å¤ å¿«ã€‚å¦‚æœçœŸçš„æƒ³é™åˆ¶ï¼Œå¯ä»¥é€™æ¨£ï¼š
                // if (inputQueue.length > 2) inputQueue.pop(); // ä¸Ÿæ£„æœ€å¾ŒåŠ å…¥çš„
            }
        }

        document.body.addEventListener('keydown', (e) => {
            // é˜»æ­¢æ–¹å‘éµæ²å‹•é é¢
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                e.preventDefault();
            }
            handleInput(e.code);
        });

        // æŒ‰éˆ•äº‹ä»¶ç›£è½
        startBtn.addEventListener('click', startGame);

        // åˆå§‹ç•«é¢
        clearScreen();
        ctx.fillStyle = '#4ade80';
        ctx.font = '20px "Press Start 2P"'; // Fallback font handled by CSS
        ctx.textAlign = 'center';
        ctx.fillText("Press Start", canvas.width / 2, canvas.height / 2);

    </script>
</body>
</html>
