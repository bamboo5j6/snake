<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶“å…¸è²ªåƒè›‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•æ²å‹•é é¢ */
            background-color: #111827;
        }

        .retro-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* éŠæˆ²ç•«å¸ƒé‚Šæ¡†ç™¼å…‰æ•ˆæœ */
        #gameCanvas {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        /* è™›æ“¬æŒ‰éˆ•æ¨£å¼ */
        .d-pad-btn {
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
        }
        .d-pad-btn:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 3px;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center bg-gray-900 text-white overflow-hidden">

    <!-- éŠæˆ²æ¨™é¡Œèˆ‡åˆ†æ•¸ -->
    <div class="w-full max-w-md flex justify-between items-center px-4 mb-4">
        <h1 class="text-xl font-bold text-green-400 flex items-center gap-2">
            <span>ğŸ</span> è²ªåƒè›‡
        </h1>
        <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
            <span class="text-gray-400 text-sm">åˆ†æ•¸</span>
            <span id="scoreEl" class="ml-2 text-xl font-bold text-white retro-font">0</span>
        </div>
    </div>

    <!-- éŠæˆ²å€åŸŸå®¹å™¨ (ç›¸å°å®šä½ç”¨æ–¼æ”¾ç½®è¦†è“‹å±¤) -->
    <div class="relative group">
        <canvas id="gameCanvas" width="400" height="400" class="bg-black rounded-lg border-2 border-gray-700 block"></canvas>
        
        <!-- UI è¦†è“‹å±¤ (é–‹å§‹/çµæŸ/æ’è¡Œæ¦œ) -->
        <div id="uiOverlay" class="absolute inset-0 bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center rounded-lg z-10 p-6 text-center">
            
            <!-- æ¨™é¡Œå€ -->
            <h2 id="gameTitle" class="text-4xl font-bold text-green-500 mb-4 retro-font tracking-widest">SNAKE</h2>
            
            <!-- åˆå§‹ç•«é¢é¡¯ç¤ºçš„å…§å®¹ -->
            <div id="startScreenContent">
                <p class="text-gray-400 mb-8 text-sm">åƒè˜‹æœï¼Œè®Šé•·ï¼Œä¸è¦æ’ç‰†ï¼</p>
            </div>

            <!-- éŠæˆ²çµæŸæ™‚é¡¯ç¤ºçš„å…§å®¹ -->
            <div id="gameOverContent" class="hidden w-full flex flex-col items-center">
                <p class="text-gray-300 mb-2">æœ€çµ‚åˆ†æ•¸: <span id="finalScoreVal" class="text-white font-bold text-xl">0</span></p>
                
                <!-- è¼¸å…¥åå­—è¡¨å–® -->
                <div id="nameInputSection" class="w-full max-w-[250px] mb-4 hidden">
                    <div class="flex gap-2">
                        <input type="text" id="playerNameInput" placeholder="è¼¸å…¥åå­—" maxlength="8" 
                            class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5 uppercase text-center">
                        <button id="saveScoreBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition">
                            å„²å­˜
                        </button>
                    </div>
                </div>

                <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
                <div class="w-full max-w-[280px] bg-gray-800/50 rounded-lg p-3 mb-4 border border-gray-700">
                    <h3 class="text-green-400 text-xs font-bold mb-2 uppercase tracking-wider border-b border-gray-700 pb-1">ğŸ† æ’è¡Œæ¦œ (Top 5)</h3>
                    <ul id="leaderboardList" class="text-sm space-y-1.5">
                        <!-- JS æœƒæ’å…¥æ’è¡Œæ¦œé …ç›® -->
                        <li class="text-gray-500 text-xs">æš«ç„¡ç´€éŒ„</li>
                    </ul>
                </div>
            </div>

            <!-- é–‹å§‹/é‡ç©æŒ‰éˆ• -->
            <button id="startBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <span id="startBtnText">é–‹å§‹éŠæˆ²</span>
            </button>

            <p class="mt-6 text-[10px] text-gray-600">é›»è…¦æŒ‰æ–¹å‘éµ â€¢ æ‰‹æ©ŸæŒ‰ä¸‹æ–¹æŒ‰éˆ•</p>
        </div>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆæ§åˆ¶å™¨ (D-Pad) -->
    <div class="mt-6 grid grid-cols-3 gap-2 w-full max-w-[280px] md:hidden">
        <div></div>
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowUp')">â¬†ï¸</button>
        <div></div>
        
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowLeft')">â¬…ï¸</button>
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowDown')">â¬‡ï¸</button>
        <button class="d-pad-btn w-16 h-16 bg-gray-800 rounded-xl flex items-center justify-center text-2xl border-b-4 border-gray-950" onclick="handleInput('ArrowRight')">â¡ï¸</button>
    </div>

    <!-- æ¡Œé¢ç«¯æç¤º -->
    <div class="hidden md:block mt-4 text-gray-500 text-sm">
        ä½¿ç”¨éµç›¤æ–¹å‘éµæ§åˆ¶ç§»å‹•
    </div>

    <script>
        // --- éŠæˆ²è¨­å®š ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('scoreEl');
        
        // UI å…ƒç´ 
        const uiOverlay = document.getElementById('uiOverlay');
        const gameTitle = document.getElementById('gameTitle');
        const startScreenContent = document.getElementById('startScreenContent');
        const gameOverContent = document.getElementById('gameOverContent');
        const finalScoreVal = document.getElementById('finalScoreVal');
        const startBtn = document.getElementById('startBtn');
        const startBtnText = document.getElementById('startBtnText');
        
        // æ’è¡Œæ¦œç›¸é—œå…ƒç´ 
        const nameInputSection = document.getElementById('nameInputSection');
        const playerNameInput = document.getElementById('playerNameInput');
        const saveScoreBtn = document.getElementById('saveScoreBtn');
        const leaderboardList = document.getElementById('leaderboardList');

        // ç¶²æ ¼è¨­å®š
        const tileCount = 20;
        let tileSize = canvas.width / tileCount - 2;
        
        function resizeCanvas() {
            const maxWidth = Math.min(window.innerWidth - 32, 400);
            canvas.width = maxWidth;
            canvas.height = maxWidth;
            tileSize = canvas.width / tileCount;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // éŠæˆ²è®Šæ•¸
        let speed = 7;
        let score = 0;
        let headX = 10;
        let headY = 10;
        let velocityX = 0;
        let velocityY = 0;
        
        class SnakePart {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }
        let snakeParts = [];
        let tailLength = 2;

        let appleX = 5;
        let appleY = 5;

        let gameInterval;
        let isRunning = false;
        let inputQueue = []; 

        // --- æ’è¡Œæ¦œé‚è¼¯ (LocalStorage) ---
        const HIGH_SCORES_KEY = 'snakeHighScores';

        function getHighScores() {
            const scores = localStorage.getItem(HIGH_SCORES_KEY);
            return scores ? JSON.parse(scores) : [];
        }

        function saveScore(name, score) {
            const highScores = getHighScores();
            const newScore = { name, score };
            
            // åŠ å…¥æ–°åˆ†æ•¸
            highScores.push(newScore);
            
            // æ’åº (åˆ†æ•¸é«˜ -> ä½)
            highScores.sort((a, b) => b.score - a.score);
            
            // åªä¿ç•™å‰ 5 å
            highScores.splice(5);
            
            // å­˜å› LocalStorage
            localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(highScores));
            
            return highScores;
        }

        function renderLeaderboard() {
            const highScores = getHighScores();
            leaderboardList.innerHTML = highScores.map((entry, index) => {
                let rankColor = 'text-gray-400';
                if (index === 0) rankColor = 'text-yellow-400';
                if (index === 1) rankColor = 'text-gray-300';
                if (index === 2) rankColor = 'text-amber-600';

                return `
                    <li class="flex justify-between items-center bg-gray-900/50 px-2 py-1 rounded hover:bg-gray-700/50 transition">
                        <span class="${rankColor} font-bold w-4">${index + 1}.</span>
                        <span class="text-gray-200 flex-1 text-left ml-2 truncate font-mono">${entry.name}</span>
                        <span class="text-green-400 font-mono font-bold">${entry.score}</span>
                    </li>
                `;
            }).join('') || '<li class="text-gray-500 text-xs italic">æš«ç„¡ç´€éŒ„ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼</li>';
        }

        // è™•ç†å„²å­˜æŒ‰éˆ•é»æ“Š
        saveScoreBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim().toUpperCase() || 'PLAYER';
            saveScore(name, score);
            
            // éš±è—è¼¸å…¥æ¡†ï¼Œæ›´æ–°åˆ—è¡¨
            nameInputSection.classList.add('hidden');
            renderLeaderboard();
        });

        // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

        function startGame() {
            if (isRunning) return;
            
            headX = 10;
            headY = 10;
            velocityX = 0;
            velocityY = 0;
            snakeParts = [];
            tailLength = 2;
            score = 0;
            speed = 7;
            inputQueue = [];
            
            scoreEl.innerText = score;
            uiOverlay.classList.add('hidden');
            
            placeApple();

            isRunning = true;
            drawGame();
        }

        function showGameOverScreen() {
            gameTitle.innerText = "GAME OVER";
            gameTitle.className = "text-4xl font-bold text-red-500 mb-2 retro-font tracking-widest";
            
            startScreenContent.classList.add('hidden');
            gameOverContent.classList.remove('hidden');
            
            finalScoreVal.innerText = score;
            startBtnText.innerText = "å†ç©ä¸€æ¬¡";

            // é¡¯ç¤ºæ’è¡Œæ¦œ
            renderLeaderboard();

            // å¦‚æœåˆ†æ•¸ > 0ï¼Œé¡¯ç¤ºè¼¸å…¥åå­—çš„å€å¡Š
            if (score > 0) {
                nameInputSection.classList.remove('hidden');
                playerNameInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                playerNameInput.focus();
            } else {
                nameInputSection.classList.add('hidden');
            }
            
            uiOverlay.classList.remove('hidden');
        }

        function gameOver() {
            isRunning = false;
            clearTimeout(gameInterval);
            showGameOverScreen();
        }

        function drawGame() {
            if (!isRunning) return;

            processInputQueue();
            changeSnakePosition();
            
            let result = isGameOver();
            if (result) {
                return gameOver();
            }

            clearScreen();
            checkAppleCollision();
            drawApple();
            drawSnake();
            
            let currentSpeed = 7 + Math.floor(score / 5); 
            if (currentSpeed > 15) currentSpeed = 15;

            gameInterval = setTimeout(drawGame, 1000 / currentSpeed);
        }

        function processInputQueue() {
            if (inputQueue.length > 0) {
                const nextDir = inputQueue.shift();
                
                if (nextDir === 'up') { velocityX = 0; velocityY = -1; }
                else if (nextDir === 'down') { velocityX = 0; velocityY = 1; }
                else if (nextDir === 'left') { velocityX = -1; velocityY = 0; }
                else if (nextDir === 'right') { velocityX = 1; velocityY = 0; }
            }
        }

        function isGameOver() {
            let gameOver = false;
            if (velocityX === 0 && velocityY === 0) return false;

            if (headX < 0 || headX >= tileCount || headY < 0 || headY >= tileCount) {
                gameOver = true;
            }

            for (let i = 0; i < snakeParts.length; i++) {
                let part = snakeParts[i];
                if (part.x === headX && part.y === headY) {
                    gameOver = true;
                    break;
                }
            }
            return gameOver;
        }

        function clearScreen() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function drawSnake() {
            ctx.fillStyle = '#4ade80'; 
            for (let i = 0; i < snakeParts.length; i++) {
                let part = snakeParts[i];
                ctx.fillRect(part.x * tileSize + 1, part.y * tileSize + 1, tileSize - 2, tileSize - 2);
            }

            snakeParts.push(new SnakePart(headX, headY));
            while (snakeParts.length > tailLength) {
                snakeParts.shift();
            }

            ctx.fillStyle = '#86efac';
            ctx.fillRect(headX * tileSize + 1, headY * tileSize + 1, tileSize - 2, tileSize - 2);
            
            ctx.fillStyle = 'black';
            if (velocityX === 1) {
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
            } else if (velocityX === -1) {
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
            } else if (velocityY === -1) {
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.2, tileSize*0.2, tileSize*0.2);
            } else {
                ctx.fillRect(headX * tileSize + tileSize * 0.2, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
                ctx.fillRect(headX * tileSize + tileSize * 0.6, headY * tileSize + tileSize * 0.6, tileSize*0.2, tileSize*0.2);
            }
        }

        function changeSnakePosition() {
            headX = headX + velocityX;
            headY = headY + velocityY;
        }

        function drawApple() {
            let cx = appleX * tileSize + tileSize / 2;
            let cy = appleY * tileSize + tileSize / 2;
            let radius = tileSize / 2 - 2;

            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(cx, cy + 1, radius, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = '#8B4513';
            ctx.fillRect(cx - 1, cy - radius - 2, 2, 4);

            ctx.fillStyle = '#4ade80';
            ctx.beginPath();
            ctx.ellipse(cx + 3, cy - radius, 3, 5, Math.PI / 4, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(cx - radius/3, cy - radius/3 + 1, radius/4, 0, 2 * Math.PI);
            ctx.fill();
        }

        function checkAppleCollision() {
            if (appleX === headX && appleY === headY) {
                placeApple();
                tailLength++;
                score++;
                scoreEl.innerText = score;
                canvas.style.transform = "scale(1.02)";
                setTimeout(() => canvas.style.transform = "scale(1)", 50);
            }
        }

        function placeApple() {
            let validPosition = false;
            while (!validPosition) {
                validPosition = true; 
                appleX = Math.floor(Math.random() * tileCount);
                appleY = Math.floor(Math.random() * tileCount);

                for (let part of snakeParts) {
                    if (part.x === appleX && part.y === appleY) {
                        validPosition = false;
                        break;
                    }
                }
                if (validPosition && headX === appleX && headY === appleY) {
                    validPosition = false;
                }
            }
        }

        function getCurrentDirection() {
            if (inputQueue.length > 0) {
                return inputQueue[inputQueue.length - 1];
            }
            if (velocityX === 1) return 'right';
            if (velocityX === -1) return 'left';
            if (velocityY === 1) return 'down';
            if (velocityY === -1) return 'up';
            return '';
        }

        function handleInput(key) {
            const direction = key.replace('Arrow', '').toLowerCase();
            const currentDir = getCurrentDirection();
            
            if (direction === 'up' && currentDir !== 'down' && currentDir !== 'up') inputQueue.push('up');
            else if (direction === 'down' && currentDir !== 'up' && currentDir !== 'down') inputQueue.push('down');
            else if (direction === 'left' && currentDir !== 'right' && currentDir !== 'left') inputQueue.push('left');
            else if (direction === 'right' && currentDir !== 'left' && currentDir !== 'right') inputQueue.push('right');

            if (inputQueue.length > 2) {}
        }

        document.body.addEventListener('keydown', (e) => {
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                e.preventDefault();
            }
            handleInput(e.code);
        });

        startBtn.addEventListener('click', startGame);

        // åˆå§‹åŒ–ï¼šæ¸…ç©ºä¸¦é¡¯ç¤ºåˆå§‹ç•«é¢
        clearScreen();
        ctx.fillStyle = '#4ade80';
        ctx.font = '20px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText("Snake Game", canvas.width / 2, canvas.height / 2);

    </script>
</body>
</html>
